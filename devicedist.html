<!DOCTYPE html>
<!--
devicedist.html

Webapp for patron devices.

-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smartphone Orchestra: Patron Node</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; text-align: center; overflow: hidden; transition: background-color 0.1s; }
        #setup-screen { padding: 20px; max-width: 400px; }
        .checklist { text-align: left; background: #111; padding: 20px; border-radius: 12px; border: 1px solid #333; margin-bottom: 25px; }
        .checklist label { display: block; margin: 15px 0; font-size: 1.1rem; cursor: pointer; }
        .checklist input { transform: scale(1.5); margin-right: 15px; }
        .btn-ready { padding: 20px 40px; font-size: 1.4rem; background: #28a745; color: white; border: none; border-radius: 50px; cursor: pointer; width: 100%; transition: 0.3s; }
        .btn-ready:disabled { background: #333; color: #777; cursor: not-allowed; }
        #loading-msg { margin-top: 20px; color: #aaa; font-style: italic; min-height: 1.2em; }
        #instruction { font-size: 1.4rem; line-height: 1.6; }
        #status { position: absolute; bottom: 15px; font-size: 0.7rem; color: #333; letter-spacing: 2px; text-transform: uppercase; width: 100%; }
        .sync-dot { display: inline-block; width: 8px; height: 8px; background: #333; border-radius: 50%; margin-left: 5px; }
        .sync-active { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h1 id="seat-label">Welcome</h1>
        <div class="checklist">
            <label><input type="checkbox" class="usher-check"> ðŸ¤« Do Not Disturb / Silent</label>
            <label><input type="checkbox" class="usher-check"> ðŸ”Š Volume at Maximum</label>
            <label><input type="checkbox" class="usher-check"> ðŸ”† Brightness at 100%</label>
        </div>
        <button class="btn-ready" id="ready-btn" disabled>PREPARE INSTRUMENT</button>
        <p id="loading-msg">Waiting for the conductor...</p>
    </div>

    <div id="show-screen" style="display:none;">
        <div id="instruction">Please silence your voice.<br>The performance is ready.</div>
    </div>

    <div id="status">OFFLINE <span id="sync-dot" class="sync-dot"></span></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBnzYesqka3zruOPjEE9eJ2ty4LZjKIlIU",
            authDomain: "smartphoneorchestra-dwt.firebaseapp.com",
            databaseURL: "https://smartphoneorchestra-dwt-default-rtdb.firebaseio.com/",
            projectId: "smartphoneorchestra-dwt",
            storageBucket: "smartphoneorchestra-dwt.firebasestorage.app",
            messagingSenderId: "722537253165",
            appId: "1:722537253165:web:8e8b6495bd508de35b2ba4"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let audioCtx, clockOffset = 0, wakeLock = null;
        let mySeat = { id: "Guest", x: 0, y: 0 };
        const audioBuffers = {};

        function init() {
            const params = new URLSearchParams(window.location.search);
            mySeat.id = params.get('id') || "Guest";
            mySeat.x = parseFloat(params.get('x')) || 0;
            mySeat.y = parseFloat(params.get('y')) || 0;
            document.getElementById('seat-label').innerText = `Seat ${mySeat.id}`;

            const checks = document.querySelectorAll('.usher-check');
            const btn = document.getElementById('ready-btn');
            checks.forEach(c => c.onclick = () => {
                btn.disabled = !Array.from(checks).every(i => i.checked);
            });
        }

        async function preloadAssets() {
            const msg = document.getElementById('loading-msg');
            msg.innerText = "Tuning instruments...";
            const snap = await db.ref('show/script').once('value');
            const script = snap.val() || [];

            for (const cue of script) {
                if (cue.type === 'AUDIO' && cue.url) {
                    try {
                        const response = await fetch(cue.url);
                        const arrayBuf = await response.arrayBuffer();
                        audioBuffers[cue.url] = await audioCtx.decodeAudioData(arrayBuf);
                    } catch (e) { console.warn("Load failed for:", cue.url); }
                }
            }
            msg.innerText = "Instruments tuned.";
        }

        function handleCue(cue) {
            // SYNC MATH
            const now = Date.now();
            const serverNow = now - clockOffset;
            const timeUntilStartMs = cue.scheduledTime - serverNow;
            const startDelaySeconds = timeUntilStartMs / 1000;

            // If the cue is already deep in the past (late arrival), skip it
            if (startDelaySeconds < -5) return;

            // SCHEDULING
            const scheduledStartTime = audioCtx.currentTime + Math.max(0, startDelaySeconds);

            if (cue.type === 'AUDIO') {
                const buffer = audioBuffers[cue.url];
                if (!buffer) return;
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(audioCtx.destination);
                source.start(scheduledStartTime);
            }

            if (cue.type === 'LIGHT') {
                setTimeout(() => {
                    document.body.style.backgroundColor = cue.color || "#fff";
                    // If spatial, we'd trigger the requestAnimationFrame loop here
                }, Math.max(0, timeUntilStartMs));
            }
        }

        document.getElementById('ready-btn').onclick = async () => {
            document.getElementById('ready-btn').disabled = true;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();

            if ('wakeLock' in navigator) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
            }

            await preloadAssets();

            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('show-screen').style.display = 'block';

            // REGISTER WITH CONDUCTOR
            db.ref(`devices/${mySeat.id}`).set({ ...mySeat, online: true });
            document.getElementById('status').innerHTML = `CONNECTED <span id="sync-dot" class="sync-dot sync-active"></span>`;

            // LISTEN FOR CUES
            db.ref('show/currentCue').on('value', snap => {
                const cue = snap.val();
                if (!cue) return;
                if (cue.action === 'KILL') location.reload();
                else handleCue(cue);
            });
        };

        // Continually sync clock with the SM Laptop
        db.ref('laptop/clock').on('value', snap => {
            if (snap.exists()) {
                clockOffset = Date.now() - snap.val();
            }
        });

        init();
    </script>
</body>
</html>