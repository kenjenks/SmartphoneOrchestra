<!DOCTYPE html>
<!--
admin.html

System janitor.

Global Blackout: This sends a specific KILL action to the show/currentCue path. This ensures that even if a device is mid-script, it receives a command to instantly close its AudioContext and black out the screen.

Pillar Monitoring: The Admin panel lets you see if all 4 pillars have successfully claimed a slot and are "Checking in."

Survey Purge: During setup, you might do several "test walks." This button allows the Sound Tech to wipe the survey_results node so the final, clean data for the seat_config.tsv can be generated without old test noise.

Database Health: Keeping the devices node empty when the show isn't running prevents Firebase from racking up unnecessary "Simultaneous Connection" charges.

Operational SOP for Admin:

* Pre-Show: (1)Upload pillar_config.json with the
  current XY locations of the 4 pillars in meters
  from front left of house.
  (2) Check Admin to ensure Pillars = 0 and Devices = 0
  (a clean slate).

* During Onboarding: Watch the Patron Nodes count
climb to match the ticket count.

* Post-Show: Hit Purge Device Registry as the audience
leaves to reset for the next performance.

-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smartphone Orchestra: System Admin</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0b0b0b; color: #eee; padding: 40px; text-align: center; }
        .container { max-width: 800px; margin: auto; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .panel { background: #1a1a1a; padding: 20px; border-radius: 12px; border: 1px solid #333; }
        .danger { border: 2px solid #ff4444; }
        .setup { border: 2px solid #007bff; }
        .status-val { font-size: 2rem; font-weight: bold; color: #00ff00; }
        button {
            width: 100%; padding: 15px; margin: 10px 0; border-radius: 8px; border: none;
            font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1rem;
        }
        .btn-soft { background: #444; color: white; }
        .btn-soft:hover { background: #555; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #bd2130; }
        .btn-warning { background: #ffc107; color: #000; }
        #log { text-align: left; background: #000; padding: 10px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; margin-top: 20px; border-radius: 5px; }

        /* Success Message Styling */
        #setup-status { margin-top: 10px; font-size: 0.9rem; min-height: 1.2rem; transition: color 0.3s; }
        .success-text { color: #00ff00; font-weight: bold; }
        .default-text { color: #888; }
    </style>
</head>
<body>

<div class="container">
    <h1>System Admin Control</h1>

    <div class="dashboard-grid">
        <div class="panel">
            <h3>Active Patron Nodes</h3>
            <div id="node-count" class="status-val">0</div>
            <p>Connected Smartphones</p>
        </div>

        <div class="panel">
            <h3>Active A9 Pillars</h3>
            <div id="pillar-count" class="status-val">0</div>
            <p>Detection Beacons Live</p>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="panel setup">
            <h3>Production Setup</h3>
            <input type="file" id="configPicker" accept=".json" style="display:none" onchange="handleFileSelect(event)">

            <button class="btn-primary" onclick="document.getElementById('configPicker').click()">
                LOAD PILLAR_CONFIG.JSON
            </button>

            <div id="setup-status" class="default-text">Select local JSON to initialize theater coordinates.</div>
        </div>

        <div class="panel">
            <h3>Show Management</h3>
            <button class="btn-soft" onclick="sendKillSignal()">GLOBAL BLACKOUT (SILENCE)</button>
            <button class="btn-soft" onclick="resetClock()">RESYNC MASTER CLOCK</button>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="panel danger">
            <h3>System Reset (Danger)</h3>
            <button class="btn-danger" onclick="purgeDevices()">PURGE DEVICE REGISTRY</button>
            <p><small>Removes all patron phones from the database.</small></p>

            <button class="btn-warning" onclick="purgeSurveyData()">CLEAR SURVEY RESULTS</button>
            <p><small>Wipes pillar heartbeats and calculated coordinates.</small></p>
        </div>
    </div>

    <div id="log">System initialized. Waiting for commands...</div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBnzYesqka3zruOPjEE9eJ2ty4LZjKIlIU",
        authDomain: "smartphoneorchestra-dwt.firebaseapp.com",
        projectId: "smartphoneorchestra-dwt",
        storageBucket: "smartphoneorchestra-dwt.firebasestorage.app",
        messagingSenderId: "722537253165",
        appId: "1:722537253165:web:8e8b6495bd508de35b2ba4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Monitoring
    db.ref('devices').on('value', (snap) => document.getElementById('node-count').innerText = snap.numChildren());
    db.ref('active_pillars').on('value', (snap) => document.getElementById('pillar-count').innerText = snap.numChildren());

    // File Handling
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const rawData = JSON.parse(e.target.result);

                // Reformat Array to Map and preferred_freq to freq
                const formattedConfig = {};
                if (rawData.pillars && Array.isArray(rawData.pillars)) {
                    rawData.pillars.forEach(p => {
                        formattedConfig[p.id] = {
                            x: p.x, y: p.y, label: p.label,
                            freq: p.preferred_freq
                        };
                    });
                }
                uploadPillarConfig(formattedConfig, file.name);
            } catch (err) {
                alert("Invalid JSON file.");
            }
        };
        reader.readAsText(file);
    }

    function uploadPillarConfig(config, fileName) {
        db.ref('active_pillars').set(config).then(() => {
            // UI SUCCESS CONFIRMATION
            const statusDisplay = document.getElementById('setup-status');
            statusDisplay.className = "success-text";
            statusDisplay.innerText = `âœ“ ${fileName} Loaded Successfully!`;

            log(`Database updated with ${Object.keys(config).length} pillars from ${fileName}.`);

            // Revert UI after 5 seconds
            setTimeout(() => {
                statusDisplay.className = "default-text";
                statusDisplay.innerText = "Select local JSON to initialize theater coordinates.";
            }, 5000);

            document.getElementById('configPicker').value = "";
        }).catch(err => {
            alert("Upload failed. Check console.");
        });
    }

    // Management Functions
    function sendKillSignal() {
        const now = Date.now();
        db.ref('show/currentCue').set({
            type: 'SYSTEM', action: 'KILL', triggerTime: now, id: 'STOP_' + now
        }).then(() => log("Sent Global Kill Signal."));
    }

    function resetClock() {
        db.ref('laptop/clock').set(Date.now());
        log("Master Clock Force-Updated.");
    }

    async function purgeDevices() {
        if (confirm("Purge all patron devices?")) {
            await db.ref('devices').remove();
            log("Device registry purged.");
        }
    }

    async function purgeSurveyData() {
        if (confirm("Clear all pillar data?")) {
            await db.ref('active_pillars').remove();
            await db.ref('survey_results').remove();
            log("Survey data purged.");
        }
    }

    function log(msg) {
        const logBox = document.getElementById('log');
        logBox.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        logBox.scrollTop = logBox.scrollHeight;
    }
</script>
</body>
</html>