<!DOCTYPE html>
<!--
laptopdist.html

Webapp for leading the Smarphone Orchestra, sending cues to patro devices over Firebase.

This is run from the Stage Manager or Sound Tech laptop. The clock of the laptop provides teh timebase for all devices.
--><html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lighthouse Conductor</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0b0b0b; color: #fff; padding: 40px; }
        .dashboard { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .panel { background: #1a1a1a; padding: 25px; border-radius: 12px; border: 1px solid #333; }
        .cue-list { height: 500px; overflow-y: auto; background: #111; padding: 10px; border-radius: 8px; }
        .cue-item { 
            padding: 15px; margin-bottom: 8px; background: #222; border-radius: 6px; 
            cursor: pointer; border-left: 4px solid transparent; transition: 0.2s;
        }
        .cue-item:hover { background: #2a2a2a; }
        .cue-item.selected { border-left-color: #ffd700; background: #2d2d2d; }
        .cue-item.active { border-left-color: #00ff00; background: #1a2a1a; }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #222; padding: 15px; border-radius: 8px; flex: 1; text-align: center; }
        button { 
            width: 100%; padding: 20px; font-size: 1.2rem; font-weight: bold; 
            border-radius: 8px; border: none; cursor: pointer; margin-top: 10px;
        }
        #go-btn { background: #28a745; color: white; }
        #go-btn:disabled { background: #333; color: #666; cursor: not-allowed; }
        #kill-btn { background: #dc3545; color: white; margin-top: 20px; }
    </style>
</head>
<body>

    <h1>Lighthouse Conductor</h1>

    <div class="stats">
        <div class="stat-card">Active Nodes: <span id="node-count" style="color:#0f0">0</span></div>
        <div class="stat-card">Master Time: <span id="clock-display">00:00:00</span></div>
        <div class="stat-card">Current Cue: <span id="current-cue-name">NONE</span></div>
    </div>

    <div class="dashboard">
        <div class="panel">
            <h3>Show Control</h3>
            <input type="file" id="cue-upload" accept=".json" style="display:none">
            <button onclick="document.getElementById('cue-upload').click()" style="background:#444; color:white;">LOAD SCRIPT (.JSON)</button>
            
            <button id="go-btn" disabled onclick="triggerNext()">GO / NEXT CUE</button>
            <button id="kill-btn" onclick="emergencyStop()">BLACKOUT / KILL ALL</button>
        </div>

        <div class="panel">
            <h3>Cue Sequence</h3>
            <div id="cue-list" class="cue-list">
                <p style="color:#666; text-align:center; margin-top:100px;">Load a script to see cues...</p>
            </div>
        </div>
    </div>

    <script>
        // --- FIREBASE INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBnzYesqka3zruOPjEE9eJ2ty4LZjKIlIU",
            authDomain: "smartphoneorchestra-dwt.firebaseapp.com",
            databaseURL: "https://smartphoneorchestra-dwt-default-rtdb.firebaseio.com/",
            projectId: "smartphoneorchestra-dwt",
            storageBucket: "smartphoneorchestra-dwt.firebasestorage.app",
            messagingSenderId: "722537253165",
            appId: "1:722537253165:web:8e8b6495bd508de35b2ba4"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let cueScript = [];
        let nextIndex = 0;
        let activeCueId = null;

        // 1. Unified Master Clock
        // All devices calculate their drift based on this laptop timestamp.
        setInterval(() => {
            const now = Date.now();
            db.ref('laptop/clock').set(now);
            document.getElementById('clock-display').innerText = new Date(now).toLocaleTimeString();
        }, 1000);

        // 2. Monitor Device Population
        db.ref('devices').on('value', (snap) => {
            const devices = snap.val() || {};
            document.getElementById('node-count').innerText = Object.keys(devices).length;
        });

        // 3. Load Cue Script
        document.getElementById('cue-upload').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                cueScript = JSON.parse(event.target.result);
                renderCues();
                document.getElementById('go-btn').disabled = false;
            };
            reader.readAsText(e.target.files[0]);
        };

        function renderCues() {
            const list = document.getElementById('cue-list');
            list.innerHTML = cueScript.map((cue, i) => {
                // This line checks for 'action', then 'asset', then 'movement'
                const detail = cue.action || cue.asset || cue.movement || "No details";

                return `
                    <div class="cue-item" id="cue-${i}" onclick="jumpToCue(${i})">
                        <div style="font-weight:bold">${cue.label}</div>
                        <div style="font-size:0.8rem; color:#aaa">${cue.type} | ${detail}</div>
                    </div>
                `;
            }).join('');
            updateSelection();
        }

        function updateSelection() {
            document.querySelectorAll('.cue-item').forEach((item, i) => {
                item.classList.toggle('selected', i === nextIndex);
                item.classList.toggle('active', i === nextIndex - 1 && activeCueId !== null);
            });
        }

        function jumpToCue(index) {
            nextIndex = index;
            updateSelection();
        }

        function triggerNext() {
            if (nextIndex >= cueScript.length) return;

            const cue = cueScript[nextIndex];
            const triggerTime = Date.now();

            // Broadcast the cue command
            // Patron devices "listen" to 'show/currentCue' and execute immediately
            db.ref('show/currentCue').set({
                ...cue,
                triggerTime: triggerTime,
                id: `cue_${triggerTime}`
            });

            document.getElementById('current-cue-name').innerText = cue.label;
            activeCueId = nextIndex;
            nextIndex++;
            updateSelection();
        }

        function emergencyStop() {
            db.ref('show/currentCue').set({ type: 'SYSTEM', action: 'KILL', triggerTime: Date.now() });
            document.getElementById('current-cue-name').innerText = "KILLED";
            activeCueId = null;
            updateSelection();
        }
    </script>
</body>
</html>