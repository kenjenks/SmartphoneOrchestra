<!DOCTYPE html>
<!--
laptopdist.html

Webapp for leading the Smarphone Orchestra, sending cues to patro devices over Firebase.

This is run from the Stage Manager or Sound Tech laptop. The clock of the laptop provides teh timebase for all devices.

-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lighthouse Conductor</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0b0b0b; color: #fff; padding: 40px; }
        .dashboard { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .panel { background: #1a1a1a; padding: 25px; border-radius: 12px; border: 1px solid #333; }
        .cue-list { height: 500px; overflow-y: auto; background: #111; padding: 10px; border-radius: 8px; }
        .cue-item {
            padding: 15px; margin-bottom: 8px; background: #222; border-radius: 6px;
            cursor: pointer; border: 2px solid transparent; transition: 0.2s;
        }
        .cue-item:hover { background: #2a2a2a; }
        .cue-item.selected { border-color: #007bff; background: #1e2a3a; }
        .cue-item.active { border-color: #28a745; background: #1a3a24; }
        .controls { display: flex; flex-direction: column; gap: 20px; }
        .btn { padding: 20px; font-size: 1.5rem; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; text-transform: uppercase; }
        .btn-trigger { background: #28a745; color: #fff; }
        .btn-trigger:hover { background: #218838; }
        .btn-stop { background: #dc3545; color: #fff; }
        .current-status { font-size: 2rem; margin-bottom: 10px; color: #aaa; }
        #current-cue-name { color: #fff; font-weight: bold; }
        #stats { color: #888; font-size: 0.9rem; }
        #stats span { color: #00ff00; font-weight: bold; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="panel">
            <h2>Cue Script (Cloud Sync)</h2>
            <div id="cue-list" class="cue-list">
                <div class="cue-item">Waiting for Admin to upload script...</div>
            </div>
        </div>

        <div class="panel controls">
            <div class="current-status">
                Next: <span id="current-cue-name">READY</span>
            </div>
            <button class="btn btn-trigger" onclick="triggerNext()">Trigger Next [Space]</button>
            <button class="btn btn-stop" onclick="emergencyStop()">Emergency Kill [K]</button>
            <hr style="width:100%; border:0; border-top:1px solid #333;">
            <div id="stats">
                <p>Connected Patrons: <span id="patron-count">0</span></p>
                <p>Master Clock: <span id="clock-display">00:00:00</span></p>
            </div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBnzYesqka3zruOPjEE9eJ2ty4LZjKIlIU",
            authDomain: "smartphoneorchestra-dwt.firebaseapp.com",
            databaseURL: "https://smartphoneorchestra-dwt-default-rtdb.firebaseio.com/",
            projectId: "smartphoneorchestra-dwt",
            storageBucket: "smartphoneorchestra-dwt.firebasestorage.app",
            messagingSenderId: "722537253165",
            appId: "1:722537253165:web:8e8b6495bd508de35b2ba4"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- CUE SYSTEM ---
        let cueScript = [];
        let nextIndex = 0;
        let activeCueId = null;

        // FIXED: Instead of fetching a local file, we listen to the Firebase node
        // updated by admin.html. This ensures the conductor is always in sync.
        db.ref('show/script').on('value', (snap) => {
            const data = snap.val();
            if (data) {
                cueScript = data;
                renderCueList();
                console.log("New script version received from cloud.");
            }
        });

        function renderCueList() {
            const cueListEl = document.getElementById('cue-list');
            cueListEl.innerHTML = '';
            cueScript.forEach((cue, i) => {
                const div = document.createElement('div');
                div.className = 'cue-item';
                div.innerHTML = `<strong>${cue.label}</strong><br><small>${cue.type}</small>`;
                div.onclick = () => jumpToCue(i);
                cueListEl.appendChild(div);
            });
            updateSelection();
        }

        function updateSelection() {
            document.querySelectorAll('.cue-item').forEach((item, i) => {
                item.classList.toggle('selected', i === nextIndex);
                item.classList.toggle('active', i === (nextIndex - 1) && activeCueId !== null);
            });
        }

        function jumpToCue(index) {
            nextIndex = index;
            updateSelection();
        }

        function triggerNext() {
            if (cueScript.length === 0 || nextIndex >= cueScript.length) return;

            const cue = cueScript[nextIndex];
            const triggerTime = Date.now();

            // Broadcast the cue to the 'currentCue' node for all patron devices
            db.ref('show/currentCue').set({
                ...cue,
                triggerTime: triggerTime,
                id: `cue_${triggerTime}`
            });

            document.getElementById('current-cue-name').innerText = cue.label;
            activeCueId = nextIndex;
            nextIndex++;
            updateSelection();
        }

        function emergencyStop() {
            db.ref('show/currentCue').set({
                type: 'SYSTEM',
                action: 'KILL',
                triggerTime: Date.now(),
                id: 'KILL_' + Date.now()
            });
            document.getElementById('current-cue-name').innerText = "KILLED";
            activeCueId = null;
            updateSelection();
        }

        // --- MONITORING & CLOCK ---
        // Watch the patron count in real-time
        db.ref('devices').on('value', snap => {
            document.getElementById('patron-count').innerText = snap.numChildren();
        });

        // Physical keyboard shortcuts for the Stage Manager
        window.onkeydown = (e) => {
            if (e.code === "Space") { e.preventDefault(); triggerNext(); }
            if (e.key === "k" || e.key === "K") { emergencyStop(); }
        };

        // Heartbeat: Set the master time every second
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock-display').innerText = now.toTimeString().split(' ')[0];
            db.ref('laptop/clock').set(Date.now());
        }, 1000);

    </script>
</body>
</html>