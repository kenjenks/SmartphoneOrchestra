<!DOCTYPE html>
<!--
laptopdist.html

Webapp for leading the Smarphone Orchestra, sending cues to patro devices over Firebase.

This is run from the Stage Manager or Sound Tech laptop. The clock of the laptop provides teh timebase for all devices.

-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SM Conductor: Scheduled Trigger</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #050505; color: #eee; padding: 20px; overflow: hidden; }
        .grid { display: grid; grid-template-columns: 1fr 450px; gap: 20px; height: 90vh; }

        .timeline-panel { background: #111; border: 1px solid #333; padding: 20px; overflow-y: auto; border-radius: 8px; }
        .timeline-item {
            display: flex; gap: 20px; padding: 15px; border-bottom: 1px solid #222; color: #666;
        }
        .timeline-item.next { color: #fff; background: #1a1a00; border-left: 5px solid #ffcc00; }
        .timeline-item.active { background: #002200; color: #00ff00; }

        .sm-controls { background: #1a1a1a; padding: 30px; border-radius: 8px; border: 2px solid #444; display: flex; flex-direction: column; justify-content: space-between; }
        .master-clock { font-family: monospace; font-size: 5rem; text-align: center; color: #00ff00; background: #000; padding: 10px; border-radius: 5px; margin-bottom: 10px; }

        .cue-card { background: #000; padding: 20px; border: 1px solid #ffcc00; border-radius: 8px; margin-bottom: 20px; }
        .cue-card h3 { margin: 0; color: #ffcc00; text-transform: uppercase; letter-spacing: 2px; }

        .btn-go {
            width: 100%; padding: 40px; font-size: 3rem; font-weight: 900;
            background: #28a745; color: white; border: none; border-radius: 12px;
            cursor: pointer; box-shadow: 0 0 20px rgba(40, 167, 69, 0.4);
        }
        .btn-go:active { background: #218838; transform: scale(0.98); }
        .btn-go:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }

        #countdown-overlay { font-size: 2rem; color: #ffcc00; text-align: center; font-weight: bold; margin-top: 10px; min-height: 1.2em; }
    </style>
</head>
<body>

<div class="grid">
    <div class="timeline-panel">
        <h2 style="color: #888;">THEATER TIMELINE</h2>
        <div id="timeline-list"></div>
    </div>

    <div class="sm-controls">
        <div>
            <div class="master-clock" id="master-clock">00:00:00</div>

            <div class="cue-card">
                <small>PENDING CUE</small>
                <h3 id="next-label">--</h3>
                <div id="next-details" style="font-size: 0.9rem; color: #888; margin-top:5px;">Waiting for timeline...</div>
            </div>

            <div id="countdown-overlay">READY</div>
        </div>

        <button id="go-button" class="btn-go" onclick="confirmTrigger()">GO</button>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button style="background:#444; padding:10px; font-size: 0.8rem;" onclick="emergencyStop()">KILL [K]</button>
            <div id="status-bar" style="font-size: 0.7rem; color: #555; align-self: center;">
                SYNC: <span id="sync-val">--</span> | PATRONS: <span id="patron-val">0</span>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBnzYesqka3zruOPjEE9eJ2ty4LZjKIlIU",
        authDomain: "smartphoneorchestra-dwt.firebaseapp.com",
        databaseURL: "https://smartphoneorchestra-dwt-default-rtdb.firebaseio.com/",
        projectId: "smartphoneorchestra-dwt",
        storageBucket: "smartphoneorchestra-dwt.firebasestorage.app",
        messagingSenderId: "722537253165",
        appId: "1:722537253165:web:8e8b6495bd508de35b2ba4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let cueLibrary = {};
    let timeline = [];
    let nextIndex = 0;
    let isCountingDown = false;

    // 1. Load Cue Library (the 'what')
    db.ref('show/script').on('value', snap => {
        const data = snap.val() || [];
        cueLibrary = {};
        data.forEach(c => cueLibrary[c.label] = c);
    });

    // 2. Load Timeline (the 'when')
    db.ref('show/timeline').on('value', snap => {
        timeline = snap.val() || [];
        renderTimeline();
    });

    function renderTimeline() {
        const list = document.getElementById('timeline-list');
        list.innerHTML = '';
        timeline.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = `timeline-item ${i === nextIndex ? 'next' : ''}`;
            div.innerHTML = `<b>${item.time}</b> <span>${item.label}</span> <small>(${item.cueLabel})</small>`;
            list.appendChild(div);
        });

        const active = timeline[nextIndex];
        if (active) {
            document.getElementById('next-label').innerText = active.label;
            document.getElementById('next-details').innerText = `Target: ${active.time} | Sync Buffer: ${active.buffer || 1.0}s`;
            document.getElementById('go-button').disabled = false;
        } else {
            document.getElementById('next-label').innerText = "END OF SHOW";
            document.getElementById('go-button').disabled = true;
        }
    }

    function confirmTrigger() {
        if (isCountingDown || !timeline[nextIndex]) return;

        const timelineEvent = timeline[nextIndex];
        const cueData = cueLibrary[timelineEvent.cueLabel];

        if (!cueData) {
            alert("Error: Cue '" + timelineEvent.cueLabel + "' not found in cues.json library.");
            return;
        }

        const bufferSeconds = timelineEvent.buffer || 1.0;
        const now = Date.now();
        const executionTime = now + (bufferSeconds * 1000);

        // BROADCAST TO CLOUD
        // Every device receives this immediately, but waits until executionTime to play.
        db.ref('show/currentCue').set({
            ...cueData,
            triggerTime: now,
            scheduledTime: executionTime,
            id: 'cue_' + now
        });

        visualCountdown(bufferSeconds);
        nextIndex++;
        renderTimeline();
    }

    function visualCountdown(seconds) {
        isCountingDown = true;
        const overlay = document.getElementById('countdown-overlay');
        let remaining = seconds;

        const timer = setInterval(() => {
            remaining -= 0.1;
            overlay.innerText = `FIRE IN: ${remaining.toFixed(1)}s`;
            if (remaining <= 0) {
                clearInterval(timer);
                overlay.innerText = "EXECUTED";
                isCountingDown = false;
                setTimeout(() => { if(!isCountingDown) overlay.innerText = "READY"; }, 2000);
            }
        }, 100);
    }

    function emergencyStop() {
        db.ref('show/currentCue').set({ type: 'SYSTEM', action: 'KILL', triggerTime: Date.now() });
        document.getElementById('countdown-overlay').innerText = "KILLED";
    }

    // CLOCK & SYNC
    setInterval(() => {
        const now = new Date();
        document.getElementById('master-clock').innerText = now.toTimeString().split(' ')[0];
        db.ref('laptop/clock').set(Date.now());
        document.getElementById('sync-val').innerText = db.ref(".info/connected") ? "OK" : "LOST";
    }, 1000);

    db.ref('devices').on('value', snap => {
        document.getElementById('patron-val').innerText = snap.numChildren();
    });

    window.onkeydown = (e) => {
        if (e.code === "Space") { e.preventDefault(); confirmTrigger(); }
        if (e.key === "k" || e.key === "K") { emergencyStop(); }
    };
</script>
</body>
</html>