<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acoustic Node: Pixel 6</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #1a1a1a; color: #fff; padding: 20px; }
        #dist { font-size: 6rem; font-weight: bold; color: #00d4ff; margin: 20px 0; }
        .status-box { padding: 15px; border-radius: 8px; background: #333; margin-bottom: 20px; }
        #status { font-weight: bold; text-transform: uppercase; }
        .btn { padding: 20px 40px; font-size: 1.2rem; cursor: pointer; border: none; border-radius: 50px; background: #007bff; color: white; transition: 0.3s; }
        .btn:disabled { background: #555; }
        #progress-bar { width: 0%; height: 10px; background: #00ff00; transition: width 0.1s; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="status-box">
        Status: <span id="status">Ready</span>
        <div id="progress-container" style="display:none;">
            <div id="progress-bar"></div>
        </div>
    </div>

    <div id="dist">-- m</div>

    <button class="btn" id="startBtn">START & CALIBRATE @ 3M</button>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = { /* PASTE YOUR FIREBASE CONFIG HERE */ };
        const GOLDEN_FREQ = 19500; // Our hard-coded silent frequency
        const CALIB_TARGET_SAMPLES = 60; // 1 minute at 1Hz
        const MOVING_AVG_SIZE = 5;

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const deviceId = "pixel6_" + Math.random().toString(36).substr(2, 4);

        let audioCtx, analyser, buffer;
        let clockSync = { local: 0, offset: 0, drift: 0 };
        let hardwareLag = 0; 
        let isCalibrated = false;
        let calibData = [];
        let distanceWindow = [];

        // --- 1. LINEAR DRIFT CLOCK SYNC ---
        async function syncClock() {
            const t0 = Date.now();
            const snap = await db.ref('laptop/clock').once('value');
            const tLaptop = snap.val();
            const t1 = Date.now();
            
            const currentOffset = tLaptop - (t1 - (t1 - t0) / 2);

            if (clockSync.local !== 0) {
                const timePassed = t1 - clockSync.local;
                const driftObserved = currentOffset - clockSync.offset;
                clockSync.drift = driftObserved / timePassed;
            }

            clockSync.local = t1;
            clockSync.offset = currentOffset;
            console.log(`Sync complete. Drift rate: ${clockSync.drift.toFixed(8)}`);
        }
        setInterval(syncClock, 120000); // Sync every 2 mins

        function getPreciseOffset() {
            const elapsed = Date.now() - clockSync.local;
            return clockSync.offset + (clockSync.drift * elapsed);
        }

        // --- 2. AUDIO PROCESSING ---
        async function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 48000 });
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
            });
            const source = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;
            source.connect(analyser);
            buffer = new Float32Array(analyser.frequencyBinCount);
        }

        function detectChirp() {
            analyser.getFloatFrequencyData(buffer);
            const bin = Math.floor(GOLDEN_FREQ / (audioCtx.sampleRate / 2) * analyser.frequencyBinCount);
            // Simple threshold detection for the silent frequency
            if (buffer[bin] > -65) return Date.now();
            return null;
        }

        // --- 3. MAIN LISTENER ---
        db.ref('beacon/latest').on('value', (snap) => {
            const beacon = snap.val();
            if (!beacon || !audioCtx) return;

            // Passive listening loop for the chirp
            let checkInterval = setInterval(() => {
                const tArrivalLocal = detectChirp();
                if (tArrivalLocal) {
                    clearInterval(checkInterval);
                    processSignal(beacon.tEmit, tArrivalLocal);
                }
            }, 5); 
            // Timeout check after 500ms to prevent hanging
            setTimeout(() => clearInterval(checkInterval), 500);
        });

        function processSignal(tEmit, tArrivalLocal) {
            const tArrivalSynced = tArrivalLocal + getPreciseOffset();
            const rawToF = tArrivalSynced - tEmit;

            if (!isCalibrated) {
                handleCalibration(rawToF);
            } else {
                const dist = ((rawToF - hardwareLag) / 1000) * 343;
                updateDisplay(dist);
            }
        }

        function handleCalibration(rawToF) {
            // Air time for 3m is ~8.75ms
            calibData.push(rawToF - 8.75);
            const progress = (calibData.length / CALIB_TARGET_SAMPLES) * 100;
            document.getElementById('progress-bar').style.width = progress + "%";

            if (calibData.length >= CALIB_TARGET_SAMPLES) {
                hardwareLag = calibData.reduce((a, b) => a + b) / calibData.length;
                isCalibrated = true;
                document.getElementById('status').innerText = "Ranging";
                document.getElementById('progress-container').style.display = "none";
                db.ref(`devices/${deviceId}`).update({ status: 'RANGING' });
            }
        }

        function updateDisplay(dist) {
            distanceWindow.push(dist);
            if (distanceWindow.length > MOVING_AVG_SIZE) distanceWindow.shift();
            const smoothed = distanceWindow.reduce((a, b) => a + b) / distanceWindow.length;
            
            document.getElementById('dist').innerText = smoothed.toFixed(2) + " m";
            db.ref(`devices/${deviceId}/distance`).set(smoothed.toFixed(2));
        }

        document.getElementById('startBtn').onclick = async () => {
            await initAudio();
            await syncClock();
            document.getElementById('startBtn').style.display = "none";
            document.getElementById('progress-container').style.display = "block";
            document.getElementById('status').innerText = "Calibrating...";
            db.ref(`devices/${deviceId}`).set({ status: 'CALIBRATING', id: deviceId });
        };
    </script>
</body>
</html>